# API Documentation Examples

This section provides comprehensive examples of Crest's API documentation features, including code samples, expected outputs, and detailed explanations.

## Table of Contents

- [Basic API Documentation](#basic-api-documentation)
- [Advanced API with Authentication](#advanced-api-with-authentication)
- [Custom Response Schemas](#custom-response-schemas)
- [Path Parameters and Validation](#path-parameters-and-validation)
- [Testing Endpoints](#testing-endpoints)

## Basic API Documentation

### Code Example

```c
#include <crest/crest.h>

// Handler functions
void get_users(crest_request_t *req, crest_response_t *res) {
    crest_response_json(res, "{\"users\": [{\"id\": 1, \"name\": \"John\"}, {\"id\": 2, \"name\": \"Jane\"}]}");
}

void create_user(crest_request_t *req, crest_response_t *res) {
    crest_response_json(res, "{\"message\": \"User created\", \"id\": 3}");
}

void get_user(crest_request_t *req, crest_response_t *res) {
    const char *id = crest_request_param(req, "id");
    char response[100];
    sprintf(response, "{\"id\": %s, \"name\": \"User %s\"}", id, id);
    crest_response_json(res, response);
}

int main(void) {
    crest_app_t *app = crest_create();

    // Enable API documentation
    crest_enable_dashboard(app, true);

    // Register routes with descriptions
    crest_get(app, "/users", get_users, "Get all users");
    crest_post(app, "/users", create_user, "Create a new user");
    crest_get(app, "/users/:id", get_user, "Get user by ID");

    printf("üåä Server running on http://localhost:8080\n");
    printf("üß† Swagger UI: http://localhost:8080/docs\n");
    printf("‚öôÔ∏è ReDoc: http://localhost:8080/redoc\n");
    printf("üßæ OpenAPI JSON: http://localhost:8080/openapi.json\n");

    crest_listen(app);
    crest_destroy(app);
    return 0;
}
```

### Expected Output

**Server Startup:**
```
üåä Server running on http://localhost:8080
üß† Swagger UI: http://localhost:8080/docs
‚öôÔ∏è ReDoc: http://localhost:8080/redoc
üßæ OpenAPI JSON: http://localhost:8080/openapi.json
```

### Generated OpenAPI JSON

When you visit `http://localhost:8080/openapi.json`, you'll see:

```json
{
  "openapi": "3.0.3",
  "info": {
    "title": "Crest API",
    "version": "1.0.0",
    "description": "API documentation generated by Crest"
  },
  "servers": [
    {
      "url": "http://localhost:8080"
    }
  ],
  "paths": {
    "/users": {
      "get": {
        "summary": "Get all users",
        "responses": {
          "200": {
            "description": "Successful response",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object"
                }
              }
            }
          }
        }
      },
      "post": {
        "summary": "Create a new user",
        "responses": {
          "200": {
            "description": "Successful response",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object"
                }
              }
            }
          }
        }
      }
    },
    "/users/{id}": {
      "get": {
        "summary": "Get user by ID",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Successful response",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object"
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "securitySchemes": {
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer"
      },
      "apiKeyAuth": {
        "type": "apiKey",
        "in": "header",
        "name": "X-API-Key"
      }
    }
  }
}
```

### Testing the Endpoints

**Get all users:**
```bash
curl http://localhost:8080/users
# {"users": [{"id": 1, "name": "John"}, {"id": 2, "name": "Jane"}]}
```

**Create a user:**
```bash
curl -X POST http://localhost:8080/users
# {"message": "User created", "id": 3}
```

**Get user by ID:**
```bash
curl http://localhost:8080/users/123
# {"id": "123", "name": "User 123"}
```

## Advanced API with Authentication

### Code Example

```c
#include <crest/crest.h>

// Authentication middleware
void auth_middleware(crest_request_t *req, crest_response_t *res, void *data) {
    const char *auth_header = crest_request_header(req, "Authorization");
    if (!auth_header || strncmp(auth_header, "Bearer ", 7) != 0) {
        crest_response_status(res, 401);
        crest_response_json(res, "{\"error\": \"Unauthorized\"}");
        return;
    }
    // Continue to next middleware/handler
}

// Protected handlers
void get_profile(crest_request_t *req, crest_response_t *res) {
    crest_response_json(res, "{\"user\": {\"id\": 1, \"email\": \"user@example.com\", \"role\": \"admin\"}}");
}

void update_profile(crest_request_t *req, crest_response_t *res) {
    crest_response_json(res, "{\"message\": \"Profile updated successfully\"}");
}

void upload_file(crest_request_t *req, crest_response_t *res) {
    crest_response_json(res, "{\"message\": \"File uploaded\", \"filename\": \"document.pdf\"}");
}

int main(void) {
    crest_app_t *app = crest_create();

    // Enable API documentation
    crest_enable_dashboard(app, true);

    // Enable CORS for API documentation
    crest_enable_cors(app, true);

    // Authentication middleware for protected routes
    crest_use(app, "/api/*", auth_middleware, NULL);

    // Public routes
    crest_get(app, "/health", health_check, "Health check endpoint");
    crest_post(app, "/auth/login", login_handler, "User login");

    // Protected routes
    crest_get(app, "/api/profile", get_profile, "Get user profile");
    crest_put(app, "/api/profile", update_profile, "Update user profile");
    crest_post(app, "/api/upload", upload_file, "Upload file");

    crest_listen(app);
    crest_destroy(app);
    return 0;
}
```

### Generated OpenAPI JSON (Security Section)

```json
{
  "components": {
    "securitySchemes": {
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "description": "JWT Bearer token authentication"
      },
      "apiKeyAuth": {
        "type": "apiKey",
        "in": "header",
        "name": "X-API-Key",
        "description": "API Key authentication"
      }
    }
  },
  "security": [
    {
      "bearerAuth": []
    }
  ]
}
```

### Testing with Authentication

**Without authentication (should fail):**
```bash
curl http://localhost:8080/api/profile
# {"error": "Unauthorized"}
```

**With authentication (should succeed):**
```bash
curl -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
     http://localhost:8080/api/profile
# {"user": {"id": 1, "email": "user@example.com", "role": "admin"}}
```

## Custom Response Schemas

### Code Example

```c
#include <crest/crest.h>

// Custom response handlers with detailed schemas
void get_products(crest_request_t *req, crest_response_t *res) {
    const char *category = crest_request_query(req, "category");
    const char *limit = crest_request_query(req, "limit");

    crest_response_json(res, "[{\"id\": 1, \"name\": \"Laptop\", \"price\": 999.99, \"category\": \"electronics\"}, {\"id\": 2, \"name\": \"Book\", \"price\": 19.99, \"category\": \"books\"}]");
}

void get_product(crest_request_t *req, crest_response_t *res) {
    const char *id = crest_request_param(req, "id");

    char response[200];
    sprintf(response, "{\"id\": %s, \"name\": \"Product %s\", \"price\": 29.99, \"description\": \"Detailed product description\", \"tags\": [\"tag1\", \"tag2\"]}", id, id);
    crest_response_json(res, response);
}

void create_order(crest_request_t *req, crest_response_t *res) {
    // In a real app, you'd parse the JSON body
    crest_response_status(res, 201);
    crest_response_json(res, "{\"order_id\": \"ORD-12345\", \"status\": \"confirmed\", \"total\": 1029.98, \"items\": [{\"product_id\": 1, \"quantity\": 1}, {\"product_id\": 2, \"quantity\": 1}]}");
}

void get_orders(crest_request_t *req, crest_response_t *res) {
    crest_response_json(res, "{\"orders\": [{\"id\": \"ORD-12345\", \"status\": \"confirmed\", \"total\": 1029.98, \"created_at\": \"2024-01-15T10:30:00Z\"}], \"pagination\": {\"page\": 1, \"limit\": 10, \"total\": 1}}");
}

int main(void) {
    crest_app_t *app = crest_create();

    crest_enable_dashboard(app, true);

    // Product endpoints
    crest_get(app, "/products", get_products, "Get products with optional filtering");
    crest_get(app, "/products/:id", get_product, "Get detailed product information");

    // Order endpoints
    crest_post(app, "/orders", create_order, "Create a new order");
    crest_get(app, "/orders", get_orders, "Get user orders with pagination");

    crest_listen(app);
    crest_destroy(app);
    return 0;
}
```

### Query Parameters and Path Parameters

**Get products with filters:**
```bash
curl "http://localhost:8080/products?category=electronics&limit=10"
# [{"id": 1, "name": "Laptop", "price": 999.99, "category": "electronics"}, ...]
```

**Get specific product:**
```bash
curl http://localhost:8080/products/123
# {"id": "123", "name": "Product 123", "price": 29.99, "description": "Detailed product description", "tags": ["tag1", "tag2"]}
```

**Create order:**
```bash
curl -X POST -H "Content-Type: application/json" \
     -d '{"items": [{"product_id": 1, "quantity": 1}]}' \
     http://localhost:8080/orders
# {"order_id": "ORD-12345", "status": "confirmed", "total": 1029.98, "items": [{"product_id": 1, "quantity": 1}, {"product_id": 2, "quantity": 1}]}
```

## Path Parameters and Validation

### Code Example

```c
#include <crest/crest.h>

// Path parameter examples
void get_user_posts(crest_request_t *req, crest_response_t *res) {
    const char *user_id = crest_request_param(req, "user_id");
    const char *post_id = crest_request_param(req, "post_id");

    char response[200];
    sprintf(response, "{\"user_id\": \"%s\", \"post_id\": \"%s\", \"content\": \"Post content for user %s, post %s\"}",
            user_id, post_id, user_id, post_id);
    crest_response_json(res, response);
}

void get_category_items(crest_request_t *req, crest_response_t *res) {
    const char *category = crest_request_param(req, "category");
    const char *subcategory = crest_request_param(req, "subcategory");
    const char *item_id = crest_request_param(req, "item_id");

    char response[300];
    sprintf(response, "{\"category\": \"%s\", \"subcategory\": \"%s\", \"item_id\": \"%s\", \"path\": \"/%s/%s/%s\"}",
            category, subcategory, item_id, category, subcategory, item_id);
    crest_response_json(res, response);
}

void search_content(crest_request_t *req, crest_response_t *res) {
    const char *query = crest_request_query(req, "q");
    const char *type = crest_request_query(req, "type");
    const char *limit = crest_request_query(req, "limit");

    char response[400];
    sprintf(response, "{\"query\": \"%s\", \"type\": \"%s\", \"limit\": \"%s\", \"results\": [{\"id\": 1, \"title\": \"Result 1\"}, {\"id\": 2, \"title\": \"Result 2\"}]}",
            query ? query : "", type ? type : "all", limit ? limit : "10");
    crest_response_json(res, response);
}

int main(void) {
    crest_app_t *app = crest_create();

    crest_enable_dashboard(app, true);

    // Multiple path parameters
    crest_get(app, "/users/:user_id/posts/:post_id", get_user_posts,
              "Get specific post from specific user");

    // Nested path parameters
    crest_get(app, "/categories/:category/:subcategory/items/:item_id", get_category_items,
              "Get item from nested category structure");

    // Query parameters
    crest_get(app, "/search", search_content,
              "Search content with query parameters");

    crest_listen(app);
    crest_destroy(app);
    return 0;
}
```

### Testing Complex Parameters

**Multiple path parameters:**
```bash
curl http://localhost:8080/users/123/posts/456
# {"user_id": "123", "post_id": "456", "content": "Post content for user 123, post 456"}
```

**Nested path parameters:**
```bash
curl http://localhost:8080/categories/electronics/laptops/items/789
# {"category": "electronics", "subcategory": "laptops", "item_id": "789", "path": "/electronics/laptops/789"}
```

**Query parameters:**
```bash
curl "http://localhost:8080/search?q=laptop&type=product&limit=5"
# {"query": "laptop", "type": "product", "limit": "5", "results": [{"id": 1, "title": "Result 1"}, {"id": 2, "title": "Result 2"}]}
```

## Testing Endpoints

### Using Swagger UI

1. **Start your server** with API documentation enabled
2. **Open Swagger UI**: Visit `http://localhost:8080/docs`
3. **Explore endpoints**: Click on any endpoint to expand it
4. **Try it out**: Click the "Try it out" button
5. **Execute**: Click "Execute" to make the API call
6. **View results**: See the response directly in the UI

### Using ReDoc

1. **Open ReDoc**: Visit `http://localhost:8080/redoc`
2. **Browse documentation**: Scroll through the clean documentation
3. **Search**: Use the search box to find specific endpoints
4. **Print**: Use browser print functionality for offline reference

### Using cURL

```bash
# Test all endpoints
curl http://localhost:8080/openapi.json | jq .  # Requires jq for pretty printing

# Test specific endpoints
curl http://localhost:8080/users
curl http://localhost:8080/users/123
curl -X POST http://localhost:8080/users

# Test with authentication
curl -H "Authorization: Bearer YOUR_TOKEN" http://localhost:8080/api/profile

# Test with query parameters
curl "http://localhost:8080/products?category=electronics&limit=10"
```

### Using PowerShell

```powershell
# Test API endpoints
Invoke-RestMethod -Uri "http://localhost:8080/users" -Method GET

# Test with headers
$headers = @{ "Authorization" = "Bearer YOUR_TOKEN" }
Invoke-RestMethod -Uri "http://localhost:8080/api/profile" -Method GET -Headers $headers

# Test POST request
$body = @{ "name" = "John"; "email" = "john@example.com" } | ConvertTo-Json
Invoke-RestMethod -Uri "http://localhost:8080/users" -Method POST -Body $body -ContentType "application/json"
```

## Summary

Crest's API documentation provides:

- **Automatic generation** from your route registrations
- **Interactive testing** via Swagger UI
- **Clean documentation** via ReDoc
- **Machine-readable specs** via OpenAPI JSON
- **Path parameter detection** and documentation
- **Security scheme support** (JWT, API keys)
- **Query parameter documentation**
- **Response schema generation**

All endpoints are automatically reserved when `crest_enable_dashboard(app, true)` is called, ensuring no conflicts with your application routes.